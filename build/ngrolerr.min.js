/*
ngrolerr 0.0.1-beta.1 - ngRolerr CRUD API Store in cookie and Roles managing for ui-route Angularjs (#*****Developing*****#) 
(C) 2015 - [object Object] 
License: MIT 
Source:  
Date Compiled: 2015-09-14 
*/
!function(a,b){"undefined"!=typeof module&&module.exports?module.exports=b(require("angular")):"function"==typeof define&&define.amd?define(["angular"],function(c){return a.ngRolerr=b(c)}):a.ngRolerr=b(a.angular)}(this,function(a){"use strict";a.module("ngRolerr",["ngCookies"]).constant("ngRolerrConfig",{rolesUrl:"",loginUrl:"",storageType:"$cookies",rolesSource:[],getUserUrl:"",getUrl:"",modeInterceptor:!0,header:"Authorization",tokenType:"Bearer"}).provider("$rolerr",["ngRolerrConfig",function(a){Object.defineProperties(this,{rolesUrl:{get:function(){return a.rolesUrl},set:function(b){a.rolesUrl=b}},modeInterceptor:{get:function(){return a.modeInterceptor},set:function(b){a.modeInterceptor=b}},getUserUrl:{get:function(){return a.getUserUrl},set:function(b){a.getUserUrl=b}},getUrl:{get:function(){return a.getUrl},set:function(b){a.getUrl=b}},rolesSource:{get:function(){return a.rolesSource},set:function(b){a.rolesSource=b}},secret:{get:function(){return a.secret},set:function(b){a.secret=b}},storageType:{get:function(){return a.storageType},set:function(b){a.storageType=b}},loginUrl:{get:function(){return a.loginUrl},set:function(b){a.loginUrl=b}}}),this.$get=["service","rolerr","authorizer",function(a,b,c){var d={};return d.isTokenResolved=function(){return b.isTokenResolved()},d.isAuthenticated=function(){return b.isAuthenticated()},d.isInRole=function(a){return b.isInRole(a)},d.isInAnyRole=function(a){return b.isInAnyRole(a)},d.authenticate=function(a){return b.authenticate(a)},d.identity=function(a){return b.identity(a)},d.authorize=function(){return c.authorize()},d.getUser=function(){return a.getUser()},d.getRoles=function(){return a.getRoles()},d.login=function(b){return a.login(b)},d.logout=function(){return a.logout()},d}]}]).factory("service",["$cookies","rolerr","$q","ngRolerrConfig","$http",function(a,b,c,d,e){return{getRoles:function(){var a=c.defer();return e.get(d.rolesUrl).success(function(b){a.resolve(b)}).error(function(b){a.reject(b)}),a.promise},getUser:function(){var a=c.defer();e.get(d.userRole).success(function(b){a.resolve(b)}).error(function(b){a.reject(b)})},getData:function(){var a=c.defer();e.get(d.getUrl).success(function(b){a.resolve(b)}).error(function(b){a.reject(b)})},login:function(a){var f=c.defer();e.post(d.loginUrl,a).success(function(a){f.resolve(a),b.authenticate(a.token)}).error(function(a){f.reject(a)})},logout:function(){return a.remove("__rolerr"),c.when()}}}]).factory("rolerr",["ngRolerrConfig","$q","$window","$timeout","$cookies",function(b,c,d,e,f){var g=void 0,h=!1;return{isTokenResolved:function(){return a.isDefined(g)},isAuthenticated:function(){var a=f.get("__rolerr");if(a){if(3===a.split(".").length){var b=a.split(".")[1],c=b.replace("-","+").replace("_","/"),e=JSON.parse(d.atob(c)).exp;if(e){var g=Math.round((new Date).getTime()/1e3)>=e;return g?(f.remove("__rolerr"),!1):!0}return!0}return!0}return!1},authenticate:function(a){g=a,h=null!=a;var b=new Date;b.setDate(b.getDate()+1),a?f.put("__rolerr",a,{expires:b}):f.remove("__rolerr")},identity:function(b){var d=c.defer();if(b===!0&&(g=void 0),a.isDefined(g))return d.resolve(g),d.promise;var h=this;return e(function(){g=f.get("__rolerr"),h.authenticate(g),d.resolve(g)}),d.promise}}}]).factory("shareservice",["ngRolerrConfig","$q","rolerr","service",function(a,b,c,d){return Array.prototype.equals=function(a){if(!a)return!1;if(null===this||null===a)return!1;if(this!==this&&a!==a)return!0;for(var b=0,c=this.length;c>b;b++)for(var d=0,c=a.length;c>d;d++)if(this[b]===a[d])return!0;return!1},{checkRolesSource:function(a,b){var d=[];if(!c.isAuthenticated()||!c.identity)return!1;for(var e=0;e<a.roles.length;e++)d.push(a.roles[e].name);return b.equals(d)}}}]).factory("authorizer",["$location","service","shareservice","$rootScope","$state","rolerr",function(a,b,c,d,e,f){return{authorize:function(){return f.identity().then(function(){f.isAuthenticated()?b.getRoles().then(function(a){d.toState.data.roles&&d.toState.data.roles.length>0&&!c.checkRolesSource(a,d.toState.data.roles)&&e.go(d.toState.data.deniedTo)},function(a){console.log("data retrieval failed.")}):(d.returnToState=d.toState,d.returnToStateParams=d.toStateParams,d.toState.data.failedTo?e.go(d.toState.data.failedTo):a.path(d.toState.url))})}}}]).config(["$httpProvider",function(a){a.interceptors.push(["$q","$cookies","ngRolerrConfig","rolerr",function(a,b,c,d){return{request:function(e){if(d.isAuthenticated()&&c.modeInterceptor){var f=b.get("__rolerr");return f=c.header&&c.tokenType?c.tokenType+" "+f:b.get("__rolerr"),e.headers[c.header]=f,e||a.when(e)}return e},responseError:function(b){return a.reject(b)}}}])}])});