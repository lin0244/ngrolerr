/*
ngrolerr 0.0.2-beta.1 - ngRolerr CRUD API Store in cookie and Roles managing for ui-route Angularjs (#*****Developing*****#) 
(C) 2015 - [object Object] 
License: MIT 
Source:  
Date Compiled: 2015-09-16 
*/
!function(a,b){"undefined"!=typeof module&&module.exports?module.exports=b(require("angular")):"function"==typeof define&&define.amd?define(["angular"],function(c){return a.ngRolerr=b(c)}):a.ngRolerr=b(a.angular)}(this,function(a){"use strict";function b(b,c,d){function e(b,d,e){var g,h;e=e||{},h=e.expires,g=a.isDefined(e.path)?e.path:f,void 0===d&&(h="Thu, 01 Jan 1970 00:00:00 GMT",d=""),a.isString(h)&&(h=new Date(h));var i=encodeURIComponent(b)+"="+encodeURIComponent(d);i+=g?";path="+g:"",i+=e.domain?";domain="+e.domain:"",i+=h?";expires="+h.toUTCString():"",i+=e.secure?";secure":"";var j=i.length+1;return j>4096&&c.warn("Cookie '"+b+"' possibly not set or overflowed because it was too large ("+j+" > 4096 bytes)!"),i}var f=d.baseHref(),g=b[0];return function(a,b,c){g.cookie=e(a,b,c)}}a.module("ngRolerr",["ng"]).constant("ngRolerrConfig",{rolesUrl:"",loginUrl:"",signupUrl:"",storageType:"cookies",rolesSource:[],getUserUrl:"",getUrl:"",modeInterceptor:!0,header:"Authorization",tokenType:"Bearer",storageName:"__rolerr"}).provider("$rolerr",["ngRolerrConfig",function(a){Object.defineProperties(this,{rolesUrl:{get:function(){return a.rolesUrl},set:function(b){a.rolesUrl=b}},modeInterceptor:{get:function(){return a.modeInterceptor},set:function(b){a.modeInterceptor=b}},getUserUrl:{get:function(){return a.getUserUrl},set:function(b){a.getUserUrl=b}},getUrl:{get:function(){return a.getUrl},set:function(b){a.getUrl=b}},rolesSource:{get:function(){return a.rolesSource},set:function(b){a.rolesSource=b}},secret:{get:function(){return a.secret},set:function(b){a.secret=b}},storageType:{get:function(){return a.storageType},set:function(b){a.storageType=b}},loginUrl:{get:function(){return a.loginUrl},set:function(b){a.loginUrl=b}},signupUrl:{get:function(){return a.signupUrl},set:function(b){a.signupUrl=b}},storageName:{get:function(){return a.storageName},set:function(b){a.storageName=b}}}),this.$get=["service","rolerr","authorizer",function(a,b,c){var d={};return d.isTokenResolved=function(){return b.isTokenResolved()},d.isAuthenticated=function(){return b.isAuthenticated()},d.isInRole=function(a){return b.isInRole(a)},d.isInAnyRole=function(a){return b.isInAnyRole(a)},d.authenticate=function(a){return b.authenticate(a)},d.identity=function(a){return b.identity(a)},d.authorize=function(){return c.authorize()},d.getUser=function(){return a.getUser()},d.getRoles=function(){return a.getRoles()},d.signup=function(b){return a.signup(b)},d.login=function(b){return a.login(b)},d.logout=function(){return a.logout()},d.get=function(b){return a.get(b)},d.post=function(b,c){return a.post(b,c)},d}]}]).factory("serviceStorage",["ngRolerrConfig","$window","$rolerrCookies",function(a,b,c){var d={},e="cookies"===a.storageType,f=function(c){var d;try{if(d=b[c],null!=d&&!e){var f="__"+Math.round(1e7*Math.random());try{b[a.storageType].setItem(f,f),b[a.storageType].removeItem(f)}catch(g){}}}catch(g){d=!1}};return f||console.warn(a.storageType+" is not supported"),d.setItem=function(d,g){return e?e?c.put(d,g):void 0:f?b[a.storageType].setItem(d,g):void 0},d.getItem=function(d){return e?e?c.get(d):void 0:f?b[a.storageType].getItem(d):void 0},d.removeItem=function(d){return e?e?c.remove(d):void 0:f?b[a.storageType].removeItem(d):void 0},d}]).factory("service",["$rolerrCookies","rolerr","$q","ngRolerrConfig","$http",function(a,b,c,d,e){return{getRoles:function(){var a=c.defer();return e.get(d.rolesUrl).success(function(b){a.resolve(b)}).error(function(b){a.reject(b)}),a.promise},getUser:function(){var a=c.defer();e.get(d.userRole).success(function(b){a.resolve(b)}).error(function(b){a.reject(b)})},getData:function(){var a=c.defer();e.get(d.getUrl).success(function(b){a.resolve(b)}).error(function(b){a.reject(b)})},login:function(a){var f=c.defer();return e.post(d.loginUrl,a).success(function(a){f.resolve(a),b.authenticate(a.token)}).error(function(a){f.reject(a)})},signup:function(a){var b=c.defer();return e.post(d.signupUrl,a).success(function(a){b.resolve(a)}).error(function(a){b.reject(a)})},logout:function(){return a.remove(d.storageName),c.when()},get:function(a){var b=c.defer();return e.get(a).success(function(a){b.resolve(a)}).error(function(a){b.reject(a)})},post:function(a,b){var d=c.defer();return e.post(a,b).success(function(a){d.resolve(a)}).error(function(a){d.reject(a)})}}}]).factory("rolerr",["ngRolerrConfig","$q","$window","$timeout","serviceStorage",function(b,c,d,e,f){var g=void 0,h=!1;return{isTokenResolved:function(){return a.isDefined(g)},isAuthenticated:function(){if(b.storageType)var a=f.getItem(b.storageName);if(a){if(3===a.split(".").length){var c=a.split(".")[1],e=c.replace("-","+").replace("_","/"),g=JSON.parse(d.atob(e)).exp;if(g){var h=Math.round((new Date).getTime()/1e3)>=g;return h?(f.removeItem(b.storageName),!1):!0}return!0}return!0}return!1},authenticate:function(a){g=a,h=null!=a;var c=new Date;c.setDate(c.getDate()+1),a?f.setItem(b.storageName,a,{expires:c}):f.removeItem(b.storageName)},identity:function(d){var h=c.defer();if(d===!0&&(g=void 0),a.isDefined(g))return h.resolve(g),h.promise;var i=this;return e(function(){g=f.getItem(b.storageName),i.authenticate(g),h.resolve(g)}),h.promise}}}]).factory("shareservice",["ngRolerrConfig","$q","rolerr","service",function(a,b,c,d){return Array.prototype.equals=function(a){if(!a)return!1;if(null===this||null===a)return!1;if(this!==this&&a!==a)return!0;for(var b=0,c=this.length;c>b;b++)for(var d=0,c=a.length;c>d;d++)if(this[b]===a[d])return!0;return!1},{checkRolesSource:function(a,b){var d=[];if(!c.isAuthenticated()||!c.identity)return!1;for(var e=0;e<a.roles.length;e++)d.push(a.roles[e].name);return b.equals(d)}}}]).factory("authorizer",["$location","service","shareservice","$rootScope","$state","rolerr",function(a,b,c,d,e,f){return{authorize:function(){return f.identity().then(function(){f.isAuthenticated()?b.getRoles().then(function(a){d.toState.data.roles&&d.toState.data.roles.length>0&&!c.checkRolesSource(a,d.toState.data.roles)&&e.go(d.toState.data.deniedTo)},function(a){console.log("data retrieval failed.")}):(d.returnToState=d.toState,d.returnToStateParams=d.toStateParams,d.toState.data.failedTo?e.go(d.toState.data.failedTo):a.path(d.toState.url))})}}}]).factory("$rolerrCookies",["$$cookieReader","$$cookieWriter",function(b,c){function d(b){return b?a.extend({},e,b):e}var e=this.defaults={};return{get:function(a){return b()[a]},put:function(a,b,e){c(a,b,d(e))},remove:function(a,b){c(a,void 0,d(b))}}}]),b.$inject=["$document","$log","$browser"],a.module("ngRolerr").provider("$$cookieWriter",function(){this.$get=b}).config(["$httpProvider",function(a){a.interceptors.push(["$q","serviceStorage","ngRolerrConfig","rolerr",function(a,b,c,d){return{request:function(e){if(d.isAuthenticated()&&c.modeInterceptor){var f=b.getItem(c.storageName);return f=c.header&&c.tokenType?c.tokenType+" "+f:b.getItem(c.storageName),e.headers[c.header]=f,e||a.when(e)}return e},responseError:function(b){return a.reject(b)}}}])}])});